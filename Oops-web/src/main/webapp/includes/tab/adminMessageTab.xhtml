<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<ui:composition 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
    xmlns:o="http://omnifaces.org/ui"
    >

    <script type="text/javascript">
        function handleSendMessage(xhr, status, args) {
            if (args.validationFailed) {
                PF('sendMsgDialog').jq.effect("shake", {times: 5}, 100);
            }
            else {
                PF('sendMsgDialog').hide();
                PF('growlError').renderMessage({summary: 'Succès!', detail: 'Votre message a été envoyé !', severity: 'info'});
            }
        }
        function handleSendAllMessage(xhr, status, args) {
            if (args.validationFailed) {
                PF('sendAllMsgDialog').jq.effect("shake", {times: 5}, 100);
            }
            else {
                PF('sendAllMsgDialog').hide();
                PF('growlError').renderMessage({summary: 'Succès!', detail: 'Votre message a été envoyé !', severity: 'info'});
            }
        }
    </script>

    <div class="container">

        <h:outputText style="font-family: Helvetica, sans-serif;margin-left: 10px" styleClass="labelTitleReviewAdmin" value=" Rechercher :"/>

        <h:form id="formResearch" style="margin-left: 20px">
            <p:autoComplete placeholder="Mots-clés" id="queryInputText" class="searchInputText" style="margin-right: 15px;" value="#{adminSearchBean.keyWord}" completeMethod="#{adminSearchBean.completeQuery}"  />
            <p:selectOneMenu id="listType" value="#{adminSearchBean.type}" style="margin-right: 15px; top:10px">
                <f:selectItem  id="tend" itemLabel="Soumissionnaire" itemValue="tend" />
                <f:selectItem id="cont" itemLabel="Prestataire" itemValue="cont"/>
                <f:ajax render="@form"/>
            </p:selectOneMenu>
            <p:commandButton id="searchButton" update="tabViewAdmin:resultResearch" style=" background-color: #336c6c; border-radius: 8px; margin-right: 15px;"   
                             value="Recherche" action="#{adminSearchBean.search()}"/>     
            <p:commandButton onclick="PF('sendAllMsgDialog').show();" value="Envoyer un message groupé" 
                              style=" background-color: #336c6c; border-radius: 8px;"
                              update="tabViewAdmin:sendAllMsgDialogForm:sendAllDialogPanel"
                              actionListener="#{adminSearchBean.init()}"
                            />
        </h:form>
        <br/>

        <h:panelGrid id="resultResearch">

            <h:panelGrid rendered="#{not empty adminSearchBean.lc}">
                <h:outputText styleClass="labelTitleReviewAdmin" value="Resultat Recherche (Prestataire)"/>

                <c:forEach items="#{adminSearchBean.lc}" var="contractor">
                    <div style="margin-left: 15px">
                        <h:form id="formSendMsg">
                            
                            <div class="divLoginTitle">
                                <h:outputText value="#{contractor.login}"/>
                            </div>
                            
                            <div style="margin-left: 20px;margin-bottom: 10px;font-family: Helvetica, sans-serif">
                                Nom : <h:outputText style="color: #008B8B;margin-right: 15px" value="#{contractor.representatorLastname}   "/>
                                Prénom : <h:outputText style="color: #008B8B;margin-right: 15px" value="#{contractor.representatorFirstname}   "/>
                                Email : <h:outputText  style="color: #008B8B;margin-right: 15px" value="#{contractor.email}   "/>
                                Téléphone : <h:outputText style="color: #008B8B;margin-right: 15px" value=" #{contractor.phone}  "/>
                            </div>
                            
                            <div style="margin-left: 20px;margin-bottom: 10px;font-family: Helvetica, sans-serif;font-size: x-small">
                                Date Inscription : <h:outputText value="#{contractor.registrationDate}"/> 
                            </div>
                            
                            <div>
                                <p:commandButton style=" background-color: #336c6c; border-radius: 8px; margin-left: 20px; margin-bottom: 10px;"
                                                 class="" actionListener="#{adminSearchBean.setContractorSelected(contractor)}"
                                                 onclick="PF('sendMsgDialog').show();"
                                                 update="tabViewAdmin:sendMsgDialogForm:dialogPanel"
                                                 value="Envoyer un message"/> 
                            </div>
                        </h:form> 
                        <hr/>
                    </div>
                </c:forEach>               

            </h:panelGrid>

            <h:panelGrid rendered="#{not empty adminSearchBean.ltd}">

                <h:outputText styleClass="labelTitleReviewAdmin" value="Resultat Recherche (Soumissionnaire)"/>

                <c:forEach items="#{adminSearchBean.ltd}" var="soum">
                    <div>
                        <h:form id="formSendMsgSoum">

                            <div class="divLoginTitle">
                                <h:outputText value="#{soum.login}"/>
                            </div>

                            <div style="margin-left: 20px;margin-bottom: 10px;">
                                Nom : <h:outputText style="color: #008B8B;margin-right: 15px" value="#{soum.lastname}   "/>
                                Prénom : <h:outputText style="color: #008B8B;margin-right: 15px" value="#{soum.firstname}   "/>
                                Email : <h:outputText  style="color: #008B8B;margin-right: 15px" value="#{soum.email}   "/>
                                Téléphone : <h:outputText style="color: #008B8B;margin-right: 15px" value=" #{soum.phone}  "/>
                            </div>
                            
                            <div style="margin-left: 20px;margin-bottom: 10px;font-family: Helvetica, sans-serif;font-size: x-small">
                                Date Inscription : <h:outputText value="#{soum.registrationDate}" style="margin-right: 15px" /> 
                                Nombre de commentaire validés : <h:outputText value="#{soum.nbReviews}" />
                            </div>
                           
                            <p:commandButton id="firstButtonSoum"
                                             style=" background-color: #336c6c; border-radius: 8px;margin-left: 20px;  margin-bottom: 10px;"
                                             actionListener="#{adminSearchBean.setTendererSelected(soum)}"
                                             onclick="PF('sendMsgDialog').show();"
                                             update="tabViewAdmin:sendMsgDialogForm:dialogPanel"
                                             value="Envoyer un message"
                                             />
                           
                        </h:form>
                        <hr/>
                    </div>
                </c:forEach>  

            </h:panelGrid>  

        </h:panelGrid>

        <p:growl widgetVar="growlError" sticky="false" showDetail="true" life="3000" />

        <o:form id="sendMsgDialogForm" includeViewParams="true">

            <p:dialog header="Envoyer un message" modal="true" widgetVar="sendMsgDialog" resizable="false">

                <p:outputPanel id="dialogPanel">

                    <c:choose>
                        <c:when test="#{adminSearchBean.type == 'cont'}">    
                            <h:outputText value="Prestataire : " style="width: 100%;"/>
                            <h:outputText id="contractorName" 
                                          value="#{adminSearchBean.contractorSelected.login} 
                                          (#{adminSearchBean.contractorSelected.representatorLastname} 
                                          #{adminSearchBean.contractorSelected.representatorFirstname})" 
                                          style="width: 100%;"/>
                        </c:when>
                        <c:otherwise>
                            <h:outputText value="Soumissionnaire : " style="width: 100%;"/>
                            <h:outputText id="soumiName" value="#{adminSearchBean.tendererSelected.login} 
                                          (#{adminSearchBean.tendererSelected.lastname} 
                                          #{adminSearchBean.tendererSelected.firstname})" 
                                          style="width: 100%;"/>
                        </c:otherwise>
                    </c:choose>   
                    <br/>
                    <h:outputLabel id="Message" value="Message :" />
                    <p:inputTextarea id="messageOut" placeholder="Tapez ici votre message."
                                     rows="6" cols="33" style="width: 100%;" value="#{adminSearchBean.message}"  
                                     required ="true" label="Message">
                        <f:validator validatorId="com.gdf.noBlankSpaceValidator" binding="#{noBlankSpaceValidator}" />
                        <f:ajax  event="blur" render="msgError"/>
                    </p:inputTextarea>
                    <p:message id="msgError" for="messageOut"/>

                    <div class="dialogFooter" >
                        <p:commandButton id="sendButtonDialogValidate" value="Envoyer" action="#{adminSearchBean.sendMessage()}"
                                         update="tabViewAdmin:sendMsgDialogForm:msgError" oncomplete="handleSendMessage(xhr, status, args)"/> 
                        <p:commandButton id="cancelButtonDialogValidate" value="Annuler" oncomplete="PF('sendMsgDialog').hide();" />
                    </div> 
                </p:outputPanel>

            </p:dialog>

        </o:form>

        <o:form id="sendAllMsgDialogForm" includeViewParams="true">

            <p:dialog header="Envoyer un message groupé" modal="true" widgetVar="sendAllMsgDialog" resizable="false">

                <p:outputPanel id="sendAllDialogPanel">

                    <p:outputLabel for="targetsOR" value="Envoyer aux :" />
                    <p:selectOneRadio id="targetsOR" value="#{adminSearchBean.targetGroup}" layout="pageDirection" 
                                      required="true">                            
                        <f:selectItem itemLabel="Soumissionnaires uniquement" itemValue="TEND" />
                        <f:selectItem itemLabel="Prestataires uniquement" itemValue="CONT" />
                        <f:selectItem itemLabel="Soumissionnaires et prestataires" itemValue="ALL" />
                    </p:selectOneRadio>
                    <br/>
                    <h:outputLabel id="allMessage" value="Message :" />
                    <p:inputTextarea id="allMessageOut" placeholder="Tapez ici votre message."
                                     rows="6" cols="33" style="width: 100%;" value="#{adminSearchBean.message}"  
                                     required ="true" label="Message">
                        <f:validator validatorId="com.gdf.noBlankSpaceValidator" binding="#{noBlankSpaceValidator}" />
                    </p:inputTextarea>
                    <p:message id="allMsgError" for="allMessageOut"/>

                    <div class="dialogFooter" >
                        <p:commandButton value="Envoyer" action="#{adminSearchBean.sendGroupMessage()}" 
                                         oncomplete="handleSendAllMessage(xhr, status, args)"
                                         update="tabViewAdmin:sendAllMsgDialogForm:sendAllDialogPanel" 
                                         /> 
                        <p:commandButton value="Annuler" oncomplete="PF('sendAllMsgDialog').hide();" />
                    </div> 
                </p:outputPanel>

            </p:dialog>

        </o:form>

    </div>

</ui:composition>