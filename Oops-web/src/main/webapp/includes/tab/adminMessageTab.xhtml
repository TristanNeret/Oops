<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<ui:composition 
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
    xmlns:o="http://omnifaces.org/ui"
    >
    
     <script type="text/javascript">
            function handleSendMessage(xhr, status, args) {
                if (args.validationFailed) {
                    PF('sendMsgDialog').jq.effect("shake", {times: 5}, 100);
                }
                else {
                    PF('sendMsgDialog').hide();
                    PF('growlError').renderMessage({summary: 'Succès!', detail: 'Votre message a été envoyé !', severity: 'info'});
                }
            }
    </script>
    
    
    <div class="divContent">
        
        <h:outputText styleClass="labelTitleReviewAdmin" value="Rechercher :"/>
        
        <h:form id="formResearch">
            <p:autoComplete  placeholder="Mots-clés" id="queryInputText" class="searchInputText" value="#{adminSearchBean.keyWord}" completeMethod="#{adminSearchBean.completeQuery}"  />
            <h:selectOneMenu id="listType" value="#{adminSearchBean.type}" style="margin-right: 5px">
                <f:selectItem  id="tend" itemLabel="Soumissionnaire" itemValue="tend"/>
                <f:selectItem id="cont" itemLabel="Prestataire" itemValue="cont"/>
                <f:ajax render="@form"/>
            </h:selectOneMenu>
            <p:commandButton id="searchButton" update="j_idt18:resultResearch"  class="searchCommandButton" value="Recherche" action="#{adminSearchBean.search()}"></p:commandButton>      

        </h:form>
        <br/>
        
        <h:panelGrid id="resultResearch">
            
            <h:panelGrid rendered="#{not empty adminSearchBean.lc}">
                <h:outputText styleClass="labelTitleReviewAdmin" value="Resultat Recherche (Prestataire)"/>
                 
                    <c:forEach items="#{adminSearchBean.lc}" var="contractor">
                        <div>
                            <h:form id="formSendMsg">
                                <div class="divLoginTitle">
                                    <h:outputText value="#{contractor.login}"/>
                                </div>
                                <div>
                                   Nom : <h:outputText style="color: #008B8B" value="#{contractor.representatorLastname}   "/>
                                   Prénom : <h:outputText style="color: #008B8B" value="#{contractor.representatorFirstname}   "/>
                                   Email : <h:outputText  style="color: #008B8B" value="#{contractor.email}   "/>
                                   Téléphone : <h:outputText style="color: #008B8B" value=" #{contractor.phone}  "/>
                                </div>
                                
                                <div>
                                    <p:commandButton actionListener="#{adminSearchBean.setContractorSelected(contractor)}"
                                                 onclick="PF('sendMsgDialog').show();"
                                                 update="j_idt18:sendMsgDialogForm:gridMsg"
                                                 value="Envoyer un message"
                                    />
                                </div>
                            </h:form>    
                        </div>
                    </c:forEach>               
            
            </h:panelGrid>
            
            <h:panelGrid rendered="#{not empty adminSearchBean.ltd}">
                
                 <h:outputText styleClass="labelTitleReviewAdmin" value="Resultat Recherche (Soumissionnaire)"/>
                 
                    <c:forEach items="#{adminSearchBean.ltd}" var="soum">
                        <div>
                            <h:form id="formSendMsgSoum">
                                
                                <div class="divLoginTitle">
                                    <h:outputText value="#{soum.login}"/>
                                </div>
                                
                                <div>
                                    Nom : <h:outputText style="color: #008B8B" value="#{soum.lastname}   "/>
                                    Prénom : <h:outputText style="color: #008B8B" value="#{soum.firstname}   "/>
                                    Email : <h:outputText  style="color: #008B8B" value="#{soum.email}   "/>
                                    Téléphone : <h:outputText style="color: #008B8B" value=" #{soum.phone}  "/>
                                </div>
                      
                                <p:commandButton actionListener="#{adminSearchBean.setTendererSelected(soum)}"
                                                 onclick="PF('sendMsgDialog').show();"
                                                 update="j_idt18:sendMsgDialogForm:gridMsg"
                                                 value="Envoyer un message"
                                /> 
                            </h:form>    
                        </div>
                    </c:forEach>  
                  
            </h:panelGrid>  
        
        </h:panelGrid>
        
        
        <o:form id="sendMsgDialogForm" includeViewParams="true">
            
            <p:growl widgetVar="growlError" sticky="false" showDetail="true" life="3000" />

            <p:dialog header="Creation du message" modal="true" widgetVar="sendMsgDialog" resizable="false">
               
                    <h:panelGrid id="gridMsg">
                       
                        <c:choose>
                            <c:when test="#{adminSearchBean.type == 'cont'}">    
                                <h:outputText value="Prestataire : " style="width: 100%;"/>
                                <h:outputText id="contractorName" value="#{adminSearchBean.contractorSelected.login} (#{adminSearchBean.contractorSelected.representatorLastname} #{adminSearchBean.contractorSelected.representatorFirstname} )" style="width: 100%;"/>
                            </c:when>
                            <c:otherwise>
                                <h:outputText value="Soumissionnaire : " style="width: 100%;"/>
                                <h:outputText id="soumiName" value="#{adminSearchBean.tendererSelected.login} (#{Bean.tendererSelected.lastname} #{adminSearchBean.tendererSelected.firstname} )" style="width: 100%;"/>
                            </c:otherwise>
                        </c:choose>   

                        <h:outputLabel id="Message" value="Message :" />
                        <p:inputTextarea id="messageOut" rows="6" cols="33" style="width: 100%;" value="#{adminSearchBean.message}"  required ="true" label="Message">
                            <f:validator validatorId="com.gdf.noBlankSpaceValidator" binding="#{noBlankSpaceValidator}" />
                        </p:inputTextarea>
                        <p:message id="msgError" for="messageOut"/>
      

                        <f:facet name="footer">
                            <p:commandButton id="sendButtonDialogValidate" value="Envoyer" action="#{adminSearchBean.sendMessage()}"
                                             update="j_idt18:sendMsgDialogForm:msgError"   oncomplete="handleSendMessage(xhr, status, args)"/> 
                            <p:commandButton id="cancelButtonDialogValidate" value="Annuler" oncomplete="PF('sendMsgDialog').hide();" />
                        </f:facet>  
                    </h:panelGrid>
                
            </p:dialog>

        </o:form>

    </div>
    
</ui:composition>