<?xml version="1.0" encoding="UTF-8"?>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:b="http://bootsfaces.net/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:c="http://xmlns.jcp.org/jsp/jstl/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:o="http://omnifaces.org/ui">

    <script type="text/javascript">
        function handleRequestPasswordForgotten(xhr, status, args) {
            if (args.validationFailed) {

            } else {
                PF('growl').renderMessage({summary: 'Lien envoyé !',
                    detail: 'Un lien pour réinitialiser votre mot de passe vient de vous être envoyé !', severity: 'info'});
                $('.wizardPseudoClass').carousel('next');
                $('.wizardPseudoClass').carousel('pause');
                // GO HOME
                setTimeout(function () {
                    window.location.href = "./"
                }, 2000);
            }
        }
         function handleRequestNewPassword(xhr, status, args) {
            if (args.validationFailed) {

            } else {
                PF('growl').renderMessage({summary: 'Mot de passe mis à jour !',
                    detail: 'Votre mot de passe a été mis a jour avec succès !', severity: 'info'});
                $('.wizardPseudoClass').carousel('next');
                $('.wizardPseudoClass').carousel('pause');
                // GO HOME
                setTimeout(function () {
                    window.location.href = "./"
                }, 2000);
            }
        }
    </script>

    <h:head>
        <title>Oops</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <h:outputStylesheet library="css" name="style.css" />

    </h:head>

    <h:body>

        <f:metadata>
            <o:viewParam name ="id" value="#{passwordForgottenBean.requestID}" />
            <f:viewAction action="#{passwordForgottenBean.init()}" />
        </f:metadata>

        <!-- HEADER -->
        <ui:include src="/includes/header.xhtml" />

        <!-- CONTENT -->
        <div class="container">

            <p:growl widgetVar="growl" sticky="false" showDetail="false" life="3000" />

            <b:carousel id="wizard" styleClass="wizardPseudoClass" startAnimation="false" showIndicators="false"
                        style="width:600px; margin-left: auto; margin-right: auto;">

                <b:carouselItem>

                    <b:panel title="Mot de passe oublié" look="primary" collapsible="false" 
                             rendered="#{passwordForgottenBean.requestID == null}">

                        <h:form>

                            <b:inputText id="mail" label="Adresse mail" renderLabel="true" value="#{passwordForgottenBean.email}"
                                         placeholder="Entrez votre adresse mail">
                                <f:facet name="prepend">
                                    <h:outputText value="@" />
                                </f:facet>
                                <f:validator validatorId="com.gdf.mailFormatValidator" />
                                <f:validator validatorId="com.gdf.emailExistValidator" />
                            </b:inputText>
                            <b:message id="mailMessage" for="mail" />

                            <p:commandButton id="sendPasswordForgottenButton"
                                             value="Envoyer" styleClass="buttonRegistration"
                                             actionListener="#{passwordForgottenBean.passwordForgotten()}" 
                                             oncomplete="handleRequestPasswordForgotten(xhr, status, args)"
                                             update="@form"/>

                        </h:form>

                    </b:panel>

                    <b:panel title="Mot de passe oublié" look="primary" collapsible="false"
                             rendered="#{passwordForgottenBean.requestID != null 
                                         and (passwordForgottenBean.tenderer != null || passwordForgottenBean.contractor != null)}">

                        <h:form>

                            <b:inputSecret id="registerPassword" label="Nouveau mot de passe" renderLabel="true" value="#{passwordForgottenBean.password}"
                                           placeholder="Entrez un mot de passe">
                                <f:facet name="prepend">
                                    <b:icon name="lock" />
                                </f:facet>                
                                <f:validator validatorId="com.gdf.passwordConfirmationValidator" />
                                <f:attribute name="confirm" value="#{confirmPassword.submittedValue}" />
                            </b:inputSecret>
                            <b:message id="passwordMessage" for="registerPassword" />

                            <b:inputSecret id="registerConfirmPassword" label="Confirmer le mot de passe" renderLabel="true" 
                                           value="#{passwordForgottenBean.passwordConfirm}"
                                           placeholder="Entrez une confirmation de mot de passe" binding="#{confirmPassword}">
                                <f:facet name="prepend">
                                    <b:icon name="lock" />
                                </f:facet>
                            </b:inputSecret>
                            <b:message id="confirmPasswordMessage" for="registerConfirmPassword" />
                            
                             <p:commandButton id="newPasswordButton"
                                             value="Envoyer" styleClass="buttonRegistration"
                                             actionListener="#{passwordForgottenBean.setNewPassword()}" 
                                             oncomplete="handleRequestNewPassword(xhr, status, args)"
                                             update="@form"/>

                        </h:form>

                    </b:panel>

                </b:carouselItem>

                <b:carouselItem>

                    <div style="width: 100%; text-align: center; height: 200px; padding-top: 100px; padding-bottom: 100px;">
                        Redirection en cours...
                    </div>

                </b:carouselItem>

                <b:carouselControl/>

            </b:carousel>
        </div>

        <!-- FOOTER -->
        <ui:include src="/includes/footer.xhtml" />

    </h:body> 

</html>